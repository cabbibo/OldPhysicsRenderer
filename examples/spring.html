<html>

  <head>
    <style>
      #container{ position:absolute; left:0px; top:0px; z-index:0; width:100%; height:100%; display:block; overflow:hidden}
      body{ margin:0px; }
    </style>
  </head>

  <body>
    <div id="container"></div>


    <script src="../lib/three.js"></script>
    <script src="../lib/jquery.min.js"></script>
    <script src="../lib/TrackballControls.js"></script>
    <script src="../lib/ShaderLoader.js"></script>
    <script src="../lib/dat.gui.min.js"></script>

    <script src="../lib/AudioController.js"></script>
    <script src="../lib/AudioTexture.js"></script>
    <script src="../lib/Stream.js"></script>
    <script src="../lib/UserAudio.js"></script>
    <script src="../lib/underscore.js"></script>


    <script src="../ParticleUtils.js"></script>
    <script src="../PhysicsRenderer.js"></script>

    <script src="js/createLineGeo.js"></script>
    <script src="js/furryTail.js"></script>

    <script>


      var paused = false;

      var audioController = new AudioController();
      
      
      /*
      audioController.mute.gain.value = 0.0;

      var userAudio = new UserAudio( audioController );
      
      userAudio.onStreamCreated = function(){
        init();
        animate();
      }*/

      var stream = new Stream( '../../audio/you.mp3' , audioController );
      //stream.play();


      
      var t_audio = audioController.texture;
      console.log( t_audio );
      
      var camera, renderer, scene , controls , clock;


      var gui = new dat.GUI({});

      var particleSystem;
      var physicsRenderer , uniforms;

      var leader;

      var dT = { type:"f" , value:0 }

      var timer = 0;

      var furryTails = [];

      var shaders = new ShaderLoader('../shaders');

      shaders.shaderSetLoaded = function(){
        init();
        animate();
        stream.play();
      }

      shaders.load( 'fs-spring' , 'render'  , 'fragment'    );
      shaders.load( 'vs-render' , 'render'  , 'vertex'      );
      shaders.load( 'tailSim'   , 'tailSim' , 'simulation'  );
      shaders.load( 'fs-lineRender' , 'lineRender' , 'fragment' );
      shaders.load( 'vs-lineRender' , 'lineRender' , 'vertex' );


      function init(){

        /*

          THREE.js Initialization

        */

        var w = window.innerWidth;
        var h = window.innerHeight;

        camera = new THREE.PerspectiveCamera( 65 , w/h , 1 , 200000 );
        camera.position.z = 100;

        //controls = new THREE.TrackballControls( camera );
        scene = new THREE.Scene();

        clock = new THREE.Clock();


        renderer = new THREE.WebGLRenderer({autoclear:false});
        renderer.setSize( window.innerWidth, window.innerHeight );

        var container = document.getElementById('container' );
        controls = new THREE.TrackballControls( camera , container );
        container.appendChild( renderer.domElement );

        var lineGeo = createLineGeo(); 
        
        /*

          Setting up attraction / repulsion uniforms

        */

      

        var d_spA = { type:"f" , value: 1.1 }
        var f_spA = { type:"f" , value: .1  }

        var d_bA = { type:"f" , value: .1 }
        var f_bA = { type:"f" , value: .4  }
      
        var d_bR = { type:"f" , value: 10.1 }
        var f_bR = { type:"f" , value: .01  }
        
        var d_sA = { type:"f" , value: 1.1 }
        var f_sA = { type:"f" , value: .1  }
        
        var d_sR = { type:"f" , value: 3.1 }
        var f_sR = { type:"f" , value: .01  }
        
        var d_sSA = { type:"f" , value: 1.1 }
        var f_sSA = { type:"f" , value: .1  }
        
        var d_sSR = { type:"f" , value: 3.1 }
        var f_sSR = { type:"f" , value: .01  }


        var allUniforms = {
  
          dist_spineAttract     : d_spA,
          force_spineAttract    : f_spA ,
          dist_bundleAttract    : d_bA,
          force_bundleAttract   : f_bA,
          dist_bundleRepel      : d_bR,
          force_bundleRepel     : f_bR,
          dist_subAttract       : d_sA,
          force_subAttract      : f_sA,
          dist_subRepel         : d_sR,
          force_subRepel        : f_sR,
          dist_subSubAttract    : d_sSA,
          force_subSubAttract   : f_sSA,
          dist_subSubRepel      : d_sSR,
          force_subSubRepel     : f_sSR,
          dT                    :  dT

        }

        gui.add( d_spA, 'value' , 0 , 10  ).name( 'dist_spineAttract' );
        gui.add( f_spA, 'value' , 0 , .5  ).name( 'force_spineAttract' );
        
        gui.add( d_bA,  'value' , 0 , 10  ).name( 'dist_bundleAttract' );
        gui.add( f_bA,  'value' , 0 , .5  ).name( 'force_bundleAttract' );
        gui.add( d_bR,  'value' , 0 , 10  ).name( 'dist_bundleRepel' );
        gui.add( f_bR,  'value' , 0 , .05 ).name( 'force_bundleRepel' );
        
        gui.add( d_sA,  'value' , 0 , 10  ).name( 'dist_subAttract' );
        gui.add( f_sA,  'value' , 0 , .5  ).name( 'force_subAttract' );
        gui.add( d_sR,  'value' , 0 , 10  ).name( 'dist_subRepel' );
        gui.add( f_sR,  'value' , 0 , .2  ).name( 'force_subRepel' );
        
        gui.add( d_sSA, 'value' , 0 , 10  ).name( 'dist_subSubAttract' );
        gui.add( f_sSA, 'value' , 0 , .5  ).name( 'force_subSubAttract' );
        gui.add( d_sSR, 'value' , 0 , 10  ).name( 'dist_subSubRepel' );
        gui.add( f_sSR, 'value' , 0 , .2  ).name( 'force_subSubRepel' );



        for( var i = 0; i < 100; i++ ){
        leader = new THREE.Vector3();

        var mesh = new THREE.Mesh(
          new THREE.IcosahedronGeometry( .4 , 1),
          new THREE.MeshNormalMaterial()
        );

        mesh.position = leader;
        scene.add( mesh );

        furryTail = new FurryTail(
          leader,
          lineGeo,
          allUniforms,
          shaders.simulationShaders.tailSim,
          renderer
        );

        furryTail.addToScene();

        //furryTail.addDebugScene( scene );
        furryTails.push( furryTail );
        }

        window.addEventListener( 'resize', onResize , false );
        
        document.addEventListener( 'keydown' , function(e){

          console.log( e.which );
          if( e.which == 32 ){

            paused = !paused;

          }

        });
      }



      function animate(){


        dT.value = clock.getDelta();

        timer += dT.value;

        audioController.update();
        
        if( !paused ){

          for( var i = 0; i < furryTails.length; i++ ){
            
            var furryTail = furryTails[i];

            var offset = timer * 1 +( i / 10 )* furryTail.speed;
            furryTail.leader.x += .01 *furryTail.radius *  Math.cos( offset ) ;
            furryTail.leader.y += .01 * furryTail.radius * Math.sin( offset );
            furryTail.leader.z += .01 * furryTail.radius  * Math.sin( offset  / 1.68);

            furryTail.update();

          }

        }

        //physicsRenderer.update();

        requestAnimationFrame( animate );
        controls.update();
        renderer.render( scene , camera );

      }

       function onResize() {
        windowHalfX = window.innerWidth / 2;
        windowHalfY = window.innerHeight / 2;
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }



    </script>

  </body>
</html>
