<html>

  <head>
    <style>
      #container{ position:absolute; left:0px; top:0px; z-index:0; width:100%; height:100%; display:block; overflow:hidden}
      body{ margin:0px; }
    </style>
  </head>

  <body>
    <div id="container"></div>


    <script src="../lib/leap.js"></script>
    <script src="../lib/three.js"></script>
    <script src="../lib/jquery.min.js"></script>
    <script src="../lib/TrackballControls.js"></script>
    <script src="../lib/ShaderLoader.js"></script>
    <script src="../lib/dat.gui.min.js"></script>

    <script src="../lib/AudioController.js"></script>
    <script src="../lib/AudioTexture.js"></script>
    <script src="../lib/Stream.js"></script>
    <script src="../lib/UserAudio.js"></script>
    <script src="../lib/underscore.js"></script>


    <script src="../ParticleUtils.js"></script>
    <script src="../PhysicsRenderer.js"></script>

    <script src="js/initTextParticles.js"></script>
    <script src="js/initRiggedSkeleton.js"></script>
    <script src="js/showDebugScenes.js"></script>
    <script src="js/createLineGeo.js"></script>
    <script src="js/FurryGroup.js"></script>
    <script src="js/FurryTail.js"></script>
    <script src="js/Cloth.js"></script>
    <script src="js/Planet.js"></script>


    <script src="../lib/TextParticles.js"></script>

    <script src="../lib/ObjectControls.js"></script>
    <script src="../lib/RiggedSkeleton.js"></script>

    <script>


      var colorSchemes = [

     /* [ 
        new THREE.Color( '#e85454' ),
        new THREE.Color( '#00b3ff' ),
        new THREE.Color( '#00ffd1' ),
        new THREE.Color( '#ff16ba' ),
        THREE.ImageUtils.loadTexture('../img/iriLookupTurquoise.png'),
        0
      ],

      

      [ 
        new THREE.Color( '#e3ff14' ),
        new THREE.Color( '#fc2597' ),
        new THREE.Color( '#773eff' ),
        new THREE.Color( '#59bbff' ),
        THREE.ImageUtils.loadTexture('../img/iriLookupNeonYellowPurp.png'),
        0
      ],


      [ 
        new THREE.Color( '#ff0c0c' ),
        new THREE.Color( '#ffdd41' ),
        new THREE.Color( '#cfb27c' ),
        new THREE.Color( '#00fff0' ),
        THREE.ImageUtils.loadTexture('../img/iriLookupOrangeTurq.png'),
        0
      ],

      [ 
        new THREE.Color( '#f0e48f' ),
        new THREE.Color( '#f7cd09' ),
        new THREE.Color( '#cfb27c' ),
        new THREE.Color( '#e3bb00' ),
        THREE.ImageUtils.loadTexture('../img/iriLookupGold.png'),
        0
      ],

         
      [ 
        new THREE.Color( '#0269de' ),
        new THREE.Color( '#0a8fac' ),
        new THREE.Color( '#aaebe7' ),
        new THREE.Color( '#0049fa' ),
        THREE.ImageUtils.loadTexture('../img/iriLookupBlue.png'),
        0
      ],


      [ 
        new THREE.Color( '#f50707' ),
        new THREE.Color( '#f56767' ),
        new THREE.Color( '#ff9b9b' ),
        new THREE.Color( '#d90404' ),
        THREE.ImageUtils.loadTexture('../img/iriLookupRed.png'),
        0
      ],

      [ 
        new THREE.Color( '#ffa400' ),
        new THREE.Color( '#ee3700' ),
        new THREE.Color( '#fce05e' ),
        new THREE.Color( '#ff70cc' ),
        THREE.ImageUtils.loadTexture('../img/iriLookupPinkRed.png'),
        1
      ],


      [ 
        new THREE.Color( '#5f5fff' ),
        new THREE.Color( '#61a2ff' ),
        new THREE.Color( '#52fff4' ),
        new THREE.Color( '#78ffc7' ),
        THREE.ImageUtils.loadTexture('../img/iriLookupGreenBluePurp.png'),
        10
      ],*/

        [ 
          'Loki',
          1,
          new THREE.Color( '#1157ff' ),
          new THREE.Color( '#00a4ff' ),
          new THREE.Color( '#5e2dff' ),
          new THREE.Color( '#00fff0' ),
          
        ],


        [ 
          'Friend1',
          3,
          new THREE.Color( '#fa0202' ),
          new THREE.Color( '#faef42' ),
          new THREE.Color( '#ff0000' ),
          new THREE.Color( '#ff7800' ),
        ],

        [
          'Friend2',
          3,
          new THREE.Color( '#5f5fff' ),
          new THREE.Color( '#61a2ff' ),
          new THREE.Color( '#52fff4' ),
          new THREE.Color( '#78ffc7' ),
        ],

        [ 
          'Friend3',
          4,
          new THREE.Color( '#ffa400' ),
          new THREE.Color( '#ee3700' ),
          new THREE.Color( '#fce05e' ),
          new THREE.Color( '#ff70cc' ),
        ],



      ]

      var centerPaused, movementPaused , allPaused ,  physicsPaused = false;

      var audioController = new AudioController();
      
      
      
      /*audioController.mute.gain.value = 0.0;

      var userAudio = new UserAudio( audioController );
      
      userAudio.onStreamCreated = function(){
        init();
        animate();
      }*/

      var stream = new Stream( '../audio/phuphuphu.mp3' , audioController );
      
      var t_audio = audioController.texture;
      
      var camera, renderer, scene , controls , clock;

      var center , riggedSkeleton;


      var colors = [];
      var gui = new dat.GUI({});

      gui.close();

      var particleSystem;
      var physicsRenderer , uniforms;

      var leader;

      var dT = { type:"f" , value:0 }

      var timer = { type:"f" , value:0 };

      var furryTails = [];
      var planets = [];
      var groups = [];
      var cloth;

      var shaders = new ShaderLoader('../shaders');

      shaders.shaderSetLoaded = function(){
        init();
        animate();
        stream.play();
      }

      shaders.load( 'fs-spring' , 'render'  , 'fragment'    );
      shaders.load( 'vs-render' , 'render'  , 'vertex'      );
      shaders.load( 'tailSim'   , 'tailSim' , 'simulation'  );
      shaders.load( 'jellySim'  , 'jellySim' , 'simulation'  );
      shaders.load( 'fs-lineRender' , 'lineRender' , 'fragment' );
      shaders.load( 'vs-lineRender' , 'lineRender' , 'vertex' );
      shaders.load( 'vs-iri' , 'iri' , 'vertex' );
      shaders.load( 'fs-iri' , 'iri' , 'fragment' );
      shaders.load( 'vs-jelly' , 'jelly' , 'vertex' );
      shaders.load( 'fs-jelly' , 'jelly' , 'fragment' );

      shaders.load( 'fs-planet' , 'planet' , 'fragment' );
      shaders.load( 'vs-planet' , 'planet' , 'vertex' );


      // TEXT
      shaders.load( 'vs-text' , 'text'         , 'vertex'    );
      shaders.load( 'fs-text' , 'text'         , 'fragment'  );
      shaders.load( 'fs-textSim'  , 'textPhysics'  , 'simulation');
      
      function init(){

        /*

          THREE.js Initialization

        */

        var w = window.innerWidth;
        var h = window.innerHeight;

        camera = new THREE.PerspectiveCamera( 65 , w/h , 1 , 200000 );
        camera.position.z = 1000;
        //camera.position.x = -1000;

        //controls = new THREE.TrackballControls( camera );
        scene = new THREE.Scene();

        scene.add( camera );

        clock = new THREE.Clock();


        renderer = new THREE.WebGLRenderer({autoclear:false});
        renderer.setSize( window.innerWidth, window.innerHeight );

        var container = document.getElementById('container' );
        controls = new THREE.TrackballControls( camera , container );
        container.appendChild( renderer.domElement );

        var lineGeo = createLineGeo(); 

        center = new THREE.Mesh( 
          new THREE.IcosahedronGeometry( .00001 , 0 ),
          new THREE.MeshNormalMaterial()
        );
        scene.add( center );

        var light=  new THREE.DirectionalLight( 0xffffff , 1 );
        light.position.set( 0 , 0 , -1 );
        scene.add( light );


        /*
          
           Leap Stuff!
        
        */
           var mesh = new THREE.Mesh(
          new THREE.IcosahedronGeometry( 30 , 0 ),
          new THREE.MeshLambertMaterial({color:0xffffff})
        );
        controller = new Leap.Controller();
        controller.connect();
        initRiggedSkeleton(mesh);

        objectControls = new ObjectControls( 
          camera , 
          riggedSkeleton.hand , 
          riggedSkeleton1.hand , 
          controller , 
          {
            indicator : mesh     
          }
        );



        /*


            Planets

        */
        
        for( var i = 0; i < colorSchemes.length; i++ ){

          var bait = center.clone();
          bait.scale.multiplyScalar( 5.3 );
          //scene.add( bait );

          var c = colorSchemes[i];

          var numOf = c[1]; //+ Math.floor( Math.random() * 10 );

          var col1 = new THREE.Vector3( c[2].r , c[2].g , c[2].b );
          var col2 = new THREE.Vector3( c[3].r , c[3].g , c[3].b );
          var col3 = new THREE.Vector3( c[4].r , c[4].g , c[4].b );
          var col4 = new THREE.Vector3( c[5].r , c[5].g , c[5].b );

          var planet = new Planet( c[0] , col1 , col2 , col3 , col4 );

          planets.push( planet );

          var f = new FurryGroup( c[0] , numOf, {
            
            center: center,
            bait: bait,
            color1: col1,
            color2: col2,
            color3: col3,
            color4: col4,

          });

          groups.push( f );

        }


        for( var i = 0; i < groups.length; i++ ){

          groups[i].updateBrethren();

        }

        for( var i = 0; i < furryTails.length; i++ ){

          var fT = furryTails[i];

          for( var j = 0; j < planets.length; j++ ){

            fT.addCollisionForce( planets[j].position , 100 );
            if( fT.type == planets[j].type ){
              fT.addDistanceForce( planets[j].position , .00004 );  
            }else{
              fT.addDistanceForce( planets[j].position , .00001 );

            }

          }

          for( var j = 0; j < furryTails.length; j++ ){

            var oFT = furryTails[j];

            if( i != j ){

              var rand = Math.random();

                //fT.addCollisionForce( oFT.position , 100 );
              
              if( j %2 == 0 ){
//fT.addDistanceInverseForce( oFT.position , 100 );


              }else{
//fT.addDistanceInverseForce( oFT.position , -100 );


              }


                //fT.addDistanceSquaredForce( oFT.position , .000001 );
                //fT.addDistanceInverseForce( oFT.position , -1000 );
              
              /*if( oFT.type == fT.type ){

                fT.addDistanceInverseForce( oFT.position , -100 );

              }else{

                fT.addDistanceForce( oFT.position , .0001 );
                
                fT.addNormalForce( oFT.position , -.1 );

              }*/

             
            }

          }

        }
       // showDebugScenes();
        
        
        window.addEventListener( 'resize', onResize , false );
        
        document.addEventListener( 'keydown' , function(e){

          console.log( e.which );
          if( e.which == 32 ){

            vsTextPosShader.material.uniforms.alive.value = 0;
            allPaused = !allPaused;

          }

          if( e.which == 45 ){

            physicsPaused = !physicsPaused;

          }

          if( e.which == 90 ){

            movementPaused = !movementPaused;

          }

        });


        //objectControls.addIndicator();


        // Text Particles!
        initTextParticles();
      }



      function animate(){

        //console.log( 

        dT.value = clock.getDelta();

        timer.value += dT.value;

        audioController.update();

        riggedSkeleton.update(0);
        riggedSkeleton1.update(1);

        objectControls.update();
        
        vsTextPosShader.update();
      
        if( !allPaused ){
          if( !centerPaused ){

            //if( controller.frame().hands[0] ){
              //center.position.copy( riggedSkeleton.hand.position );
           // }else{

            var target = new THREE.Vector3();
            var dir = camera.position.clone().normalize().multiplyScalar( -1 );
            var up = camera.up.clone();
            var right = dir.clone().cross( up );
            
            right.normalize();

            target.add( right.multiplyScalar( -250 ) );
            target.add( camera.position );
            target.add( dir.multiplyScalar( 1000 ));

              center.position.sub( center.position.clone().sub( target ).multiplyScalar( .1 ) );

           // }
            /*center.position.x = Math.sin( timer.value /2 ) * 120;
            center.position.y = Math.cos( timer.value /1 ) * 120;
            center.position.z = Math.cos( timer.value / 1.5542) * 100;*/

          }

          if( !physicsPaused ){


            for( var i = 0; i < furryTails.length; i++ ){

              var furryTail = furryTails[i];
              furryTail.updateTail();

            }

          }

          if( !movementPaused ){


            for( var i = 0; i < furryTails.length; i++ ){

              var furryTail = furryTails[i];
              furryTail.updatePhysics();

            }


          }

        }

        //physicsRenderer.update();

        requestAnimationFrame( animate );
        controls.update();
        renderer.render( scene , camera );

      }

       function onResize() {
        windowHalfX = window.innerWidth / 2;
        windowHalfY = window.innerHeight / 2;
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }



    </script>

  </body>
</html>
