<html>

  <head>
    <style>
      #container{ position:absolute; left:0px; top:0px; }
      body{ margin:0px; }
    </style>
  </head>

  <body>

    <script src="../lib/three.js"></script>
    <script src="../lib/jquery.min.js"></script>
    <script src="../lib/TrackballControls.js"></script>
    <script src="../lib/ShaderLoader.js"></script>
    
    <script src="../ParticleUtils.js"></script>
    <script src="../PhysicsRenderer.js"></script>

    <script>


      var paused = false;


      var camera, renderer, scene , controls , clock;
      
      var particleSystem;
      var physicsRenderer , uniforms;

      var leader;

      var dT = { type:"f" , value:0 }

      var timer = 0;
      // Using: https://github.com/cabbibo/ShaderLoader
      // For More info: http://cabbibo.github.io/ShaderLoader/

      var shaders = new ShaderLoader('../shaders');

      shaders.shaderSetLoaded = function(){
        init();
        animate();
      }

      shaders.load( 'fs-spring' , 'render'  , 'fragment'    );
      shaders.load( 'vs-render' , 'render'  , 'vertex'      );
      shaders.load( 'tailSim'   , 'tailSim' , 'simulation'  );


      function init(){

        /*

          THREE.js Initialization

        */

        var w = window.innerWidth;
        var h = window.innerHeight;

        camera = new THREE.PerspectiveCamera( 65 , w/h , 1 , 200000 );
        camera.position.z = 100;

        controls = new THREE.TrackballControls( camera );
        scene = new THREE.Scene();

        clock = new THREE.Clock();


        renderer = new THREE.WebGLRenderer();
        renderer.setSize( window.innerWidth, window.innerHeight );

        document.body.appendChild( renderer.domElement );

        size = 32;

        var sim = shaders.simulationShaders.tailSim;
        physicsRenderer = new PhysicsRenderer( size , sim , renderer ); 

        leader = new THREE.Vector3();

        var mesh = new THREE.Mesh(
          new THREE.IcosahedronGeometry( .5 , 1 ),
          new THREE.MeshNormalMaterial()
        );

        mesh.position = leader;
        scene.add( mesh );


        var leaderU = { type:"v3" , value: leader } 
        physicsRenderer.setUniform( 'leader' , leaderU );
        physicsRenderer.setUniform( 'dT' , dT );
        
        
        uniforms = {
          t_pos:{ type:"t" , value:null },
          t_oPos:{ type:"t" , value:null },
          t_ooPos:{ type:"t" , value:null },
        }

        var mat = new THREE.ShaderMaterial({
          uniforms: uniforms,
          vertexShader: shaders.vertexShaders.render,
          fragmentShader: shaders.fragmentShaders.render
        })

        var geo = ParticleUtils.createLookupGeometry( size );

        physicsParticles  = new THREE.ParticleSystem( geo , mat );

        physicsRenderer.addBoundTexture( physicsParticles , 't_pos' , 'output' );
        physicsRenderer.addBoundTexture( physicsParticles , 't_oPos' , 'oOutput' );
        physicsRenderer.addBoundTexture( physicsParticles , 't_ooPos' , 'ooOutput' );

        scene.add( physicsParticles );

        var mesh = new THREE.Mesh( new THREE.SphereGeometry( 5 ) );

        var pTexture = ParticleUtils.createPositionsTexture( size , mesh );
        physicsRenderer.reset( pTexture );

        physicsRenderer.debugScene.scale.multiplyScalar( .1 );
        physicsRenderer.debugScene.position.y = 20;
        physicsRenderer.addDebugScene( scene );

        document.addEventListener( 'keydown' , function(e){

          console.log( e.which );
          if( e.which == 32 ){

            paused = !paused;

          }

        });
      }



      function animate(){


        dT.value = clock.getDelta();

        timer += dT.value;
        
        if( !paused ){
          
          leader.x = 80 *  Math.cos( timer);
          leader.y = 80 * Math.sin( timer);
          leader.z = 150 * Math.sin( timer);

          physicsRenderer.update();
          
        }

        //physicsRenderer.update();

        requestAnimationFrame( animate );
        controls.update();
        renderer.render( scene , camera );

      }

    </script>

  </body>
</html>
