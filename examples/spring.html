<html>

  <head>
    <style>
      #container{ position:absolute; left:0px; top:0px; z-index:0; width:100%; height:100%; display:block; overflow:hidden}
      body{ margin:0px; }
    </style>
  </head>

  <body>
    <div id="container"></div>


    <script src="../lib/three.js"></script>
    <script src="../lib/jquery.min.js"></script>
    <script src="../lib/TrackballControls.js"></script>
    <script src="../lib/ShaderLoader.js"></script>
    <script src="../lib/dat.gui.min.js"></script>

    <script src="../lib/AudioController.js"></script>
    <script src="../lib/AudioTexture.js"></script>
    <script src="../lib/Stream.js"></script>
    <script src="../lib/UserAudio.js"></script>
    <script src="../lib/underscore.js"></script>


    <script src="../ParticleUtils.js"></script>
    <script src="../PhysicsRenderer.js"></script>

    <script src="js/createLineGeo.js"></script>
    <script src="js/FurryGroup.js"></script>
    <script src="js/FurryTail.js"></script>

    <script>


      var centerPaused, movementPaused , physicsPaused = false;

      var audioController = new AudioController();
      
      
      
      audioController.mute.gain.value = 0.0;

      var userAudio = new UserAudio( audioController );
      
      userAudio.onStreamCreated = function(){
        init();
        animate();
      }

      var stream = new Stream( '../../audio/saturnStrobe.mp3' , audioController );
      //stream.play();


      
      var t_audio = audioController.texture;
      console.log( t_audio );
      
      var camera, renderer, scene , controls , clock;

      var center;

      var colors = [];
      var gui = new dat.GUI({});

      var particleSystem;
      var physicsRenderer , uniforms;

      var leader;

      var dT = { type:"f" , value:0 }

      var timer = 0;

      var furryTails = [];

      var shaders = new ShaderLoader('../shaders');

      shaders.shaderSetLoaded = function(){
       /* init();
        animate();
        stream.play();*/
      }

      shaders.load( 'fs-spring' , 'render'  , 'fragment'    );
      shaders.load( 'vs-render' , 'render'  , 'vertex'      );
      shaders.load( 'tailSim'   , 'tailSim' , 'simulation'  );
      shaders.load( 'fs-lineRender' , 'lineRender' , 'fragment' );
      shaders.load( 'vs-lineRender' , 'lineRender' , 'vertex' );


      function init(){

        /*

          THREE.js Initialization

        */

        var w = window.innerWidth;
        var h = window.innerHeight;

        camera = new THREE.PerspectiveCamera( 65 , w/h , 1 , 200000 );
        camera.position.z = 100;

        //controls = new THREE.TrackballControls( camera );
        scene = new THREE.Scene();

        clock = new THREE.Clock();


        renderer = new THREE.WebGLRenderer({autoclear:false});
        renderer.setSize( window.innerWidth, window.innerHeight );

        var container = document.getElementById('container' );
        controls = new THREE.TrackballControls( camera , container );
        container.appendChild( renderer.domElement );

        var lineGeo = createLineGeo(); 

        center = new THREE.Mesh( 
          new THREE.IcosahedronGeometry( 10 , 0 ),
          new THREE.MeshNormalMaterial()
        );

        scene.add( center );


        groups = [];

        for( var i = 0; i < 4; i++ ){

          var bait = center.clone();
          bait.scale.multiplyScalar( .3 );
          scene.add( bait );

          var numOf = 1 + Math.floor( Math.random() * 10 );
          var f = new FurryGroup( 'PUPPY '+i , numOf, {

            center: center,
            bait: bait

          });

          groups.push( f );

        }

        for( var i = 0; i < groups.length; i++ ){

          groups[i].updateBrethren();

        }
      
        window.addEventListener( 'resize', onResize , false );
        
        document.addEventListener( 'keydown' , function(e){

          console.log( e.which );
          if( e.which == 32 ){

            centerPaused = !centerPaused;

          }

          if( e.which == 45 ){

            physicsPaused = !physicsPaused;

          }

          if( e.which == 90 ){

            movementPaused = !movementPaused;

          }



        });
      }



      function animate(){

        //console.log( 

        dT.value = clock.getDelta();

        timer += dT.value;

        audioController.update();



        if( !centerPaused ){

          center.position.x = Math.sin( timer ) * 8;
          center.position.y = Math.cos( timer ) * 8;
          center.position.z = Math.cos( timer / 1.542) * 10;

        }

        if( !physicsPaused ){


          for( var i = 0; i < furryTails.length; i++ ){

            var furryTail = furryTails[i];
            furryTail.updateTail();

          }

        }

        if( !movementPaused ){

          for( var i = 0; i < groups.length; i++ ){

            groups[i].updatePhysics();


          }

          for( var i = 0; i < furryTails.length; i++ ){

            var furryTail = furryTails[i];
            furryTail.updatePhysics();

          }


        }

        //physicsRenderer.update();

        requestAnimationFrame( animate );
        controls.update();
        renderer.render( scene , camera );

      }

       function onResize() {
        windowHalfX = window.innerWidth / 2;
        windowHalfY = window.innerHeight / 2;
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }



    </script>

  </body>
</html>
