<html>

  <head>
    <style>
      #container{ position:absolute; left:0px; top:0px; z-index:0; width:100%; height:100%; display:block; overflow:hidden}
      body{ margin:0px; }
    </style>
  </head>

  <body>
    <div id="container"></div>


    <script src="../lib/leap.js"></script>
    <script src="../lib/three.js"></script>
    <script src="../lib/jquery.min.js"></script>
    <script src="../lib/TrackballControls.js"></script>
    <script src="../lib/ShaderLoader.js"></script>
    <script src="../lib/dat.gui.min.js"></script>

    <script src="../lib/AudioController.js"></script>
    <script src="../lib/AudioTexture.js"></script>
    <script src="../lib/Stream.js"></script>
    <script src="../lib/UserAudio.js"></script>
    <script src="../lib/underscore.js"></script>


    <script src="../ParticleUtils.js"></script>
    <script src="../PhysicsRenderer.js"></script>

    <script src="js/createLineGeo.js"></script>
    <script src="js/FurryGroup.js"></script>
    <script src="js/FurryTail.js"></script>
    <script src="js/Cloth.js"></script>

    <script src="../lib/RiggedSkeleton.js"></script>

    <script>


      var colorSchemes = [

     /* [ 
        new THREE.Color( '#e85454' ),
        new THREE.Color( '#00b3ff' ),
        new THREE.Color( '#00ffd1' ),
        new THREE.Color( '#ff16ba' ),
        THREE.ImageUtils.loadTexture('../img/iriLookupTurquoise.png'),
        0
      ],

      

      [ 
        new THREE.Color( '#e3ff14' ),
        new THREE.Color( '#fc2597' ),
        new THREE.Color( '#773eff' ),
        new THREE.Color( '#59bbff' ),
        THREE.ImageUtils.loadTexture('../img/iriLookupNeonYellowPurp.png'),
        0
      ],


      [ 
        new THREE.Color( '#ff0c0c' ),
        new THREE.Color( '#ffdd41' ),
        new THREE.Color( '#cfb27c' ),
        new THREE.Color( '#00fff0' ),
        THREE.ImageUtils.loadTexture('../img/iriLookupOrangeTurq.png'),
        0
      ],

      [ 
        new THREE.Color( '#f0e48f' ),
        new THREE.Color( '#f7cd09' ),
        new THREE.Color( '#cfb27c' ),
        new THREE.Color( '#e3bb00' ),
        THREE.ImageUtils.loadTexture('../img/iriLookupGold.png'),
        0
      ],

         
      [ 
        new THREE.Color( '#0269de' ),
        new THREE.Color( '#0a8fac' ),
        new THREE.Color( '#aaebe7' ),
        new THREE.Color( '#0049fa' ),
        THREE.ImageUtils.loadTexture('../img/iriLookupBlue.png'),
        0
      ],


      [ 
        new THREE.Color( '#f50707' ),
        new THREE.Color( '#f56767' ),
        new THREE.Color( '#ff9b9b' ),
        new THREE.Color( '#d90404' ),
        THREE.ImageUtils.loadTexture('../img/iriLookupRed.png'),
        0
      ],*/

      [ 
        new THREE.Color( '#ffa400' ),
        new THREE.Color( '#ee3700' ),
        new THREE.Color( '#fce05e' ),
        new THREE.Color( '#ff70cc' ),
        THREE.ImageUtils.loadTexture('../img/iriLookupPinkRed.png'),
        1
      ],


      [ 
        new THREE.Color( '#5f5fff' ),
        new THREE.Color( '#61a2ff' ),
        new THREE.Color( '#52fff4' ),
        new THREE.Color( '#78ffc7' ),
        THREE.ImageUtils.loadTexture('../img/iriLookupGreenBluePurp.png'),
        10
      ],




      ]

      var centerPaused, movementPaused , allPaused ,  physicsPaused = false;

      var audioController = new AudioController();
      
      
      
      audioController.mute.gain.value = 0.0;

      var userAudio = new UserAudio( audioController );
      
      userAudio.onStreamCreated = function(){
        init();
        animate();
      }

      var stream = new Stream( '../../audio/saturnStrobe.mp3' , audioController );
      //stream.play();


      
      var t_audio = audioController.texture;
      console.log( t_audio );
      
      var camera, renderer, scene , controls , clock;

      var center , riggedSkeleton;

      var colors = [];
      var gui = new dat.GUI({});

      var particleSystem;
      var physicsRenderer , uniforms;

      var leader;

      var dT = { type:"f" , value:0 }

      var timer = { type:"f" , value:0 };

      var furryTails = [];
      var cloth;

      var shaders = new ShaderLoader('../shaders');

      shaders.shaderSetLoaded = function(){
       /* init();
        animate();
        stream.play();*/
      }

      shaders.load( 'fs-spring' , 'render'  , 'fragment'    );
      shaders.load( 'vs-render' , 'render'  , 'vertex'      );
      shaders.load( 'tailSim'   , 'tailSim' , 'simulation'  );
      shaders.load( 'jellySim'  , 'jellySim' , 'simulation'  );
      shaders.load( 'fs-lineRender' , 'lineRender' , 'fragment' );
      shaders.load( 'vs-lineRender' , 'lineRender' , 'vertex' );
      shaders.load( 'vs-iri' , 'iri' , 'vertex' );
      shaders.load( 'fs-iri' , 'iri' , 'fragment' );
      shaders.load( 'vs-jelly' , 'jelly' , 'vertex' );
      shaders.load( 'fs-jelly' , 'jelly' , 'fragment' );


      function init(){

        /*

          THREE.js Initialization

        */

        var w = window.innerWidth;
        var h = window.innerHeight;

        camera = new THREE.PerspectiveCamera( 65 , w/h , 1 , 200000 );
        camera.position.z = 1000;

        //controls = new THREE.TrackballControls( camera );
        scene = new THREE.Scene();

        clock = new THREE.Clock();


        renderer = new THREE.WebGLRenderer({autoclear:false});
        renderer.setSize( window.innerWidth, window.innerHeight );

        var container = document.getElementById('container' );
        controls = new THREE.TrackballControls( camera , container );
        container.appendChild( renderer.domElement );

        var lineGeo = createLineGeo(); 

        center = new THREE.Mesh( 
          new THREE.IcosahedronGeometry( 10 , 0 ),
          new THREE.MeshNormalMaterial()
        );


        //scene.add( center );

        controller = new Leap.Controller();
        controller.connect();
        riggedSkeleton = new RiggedSkeleton( controller , {

          movementSize: 1000,
          handSize: 100
          
        });

        var mesh = new THREE.Mesh(
          new THREE.BoxGeometry( 30 , 30  , 100 ),
          new THREE.MeshNormalMaterial({color:0xcc9999})
        );

        riggedSkeleton.addScaledJointMesh( mesh , 'metacarpal' );
        riggedSkeleton.addScaledJointMesh( mesh , 'distal' );
        riggedSkeleton.addScaledJointMesh( mesh , 'intermediate' );
        riggedSkeleton.addScaledJointMesh( mesh , 'proximal' );
        ///riggedSkeleton.addScaledJointMesh( mesh , 'distal' );

        riggedSkeleton.addToScene( scene );
        
        groups = [];

        for( var i = 0; i < colorSchemes.length; i++ ){

          var bait = center.clone();
          bait.scale.multiplyScalar( .3 );
          //scene.add( bait );

          var c = colorSchemes[i];
          
          var numOf = c[5]; //+ Math.floor( Math.random() * 10 );

          var f = new FurryGroup( 'PUPPY '+i , numOf, {

            center: center,
            bait: bait,
            color1: new THREE.Vector3( c[0].r , c[0].g , c[0].b ),
            color2: new THREE.Vector3( c[1].r , c[1].g , c[1].b ),
            color3: new THREE.Vector3( c[2].r , c[2].g , c[2].b ),
            color4: new THREE.Vector3( c[3].r , c[3].g , c[3].b ),
            iriLookup: c[4]

          });

          groups.push( f );

        }

        for( var i = 0; i < groups.length; i++ ){

          groups[i].updateBrethren();

        }
      
        window.addEventListener( 'resize', onResize , false );
        
        document.addEventListener( 'keydown' , function(e){

          console.log( e.which );
          if( e.which == 32 ){

            allPaused = !allPaused;

          }

          if( e.which == 45 ){

            physicsPaused = !physicsPaused;

          }

          if( e.which == 90 ){

            movementPaused = !movementPaused;

          }



        });
      }



      function animate(){

        //console.log( 

        dT.value = clock.getDelta();

        timer.value += dT.value;

        audioController.update();

        riggedSkeleton.update();


        if( !allPaused ){
          if( !centerPaused ){

            if( controller.frame().hands[0] ){
              center.position.copy( riggedSkeleton.hand.position );
            }else{
              center.position.sub( center.position.clone().multiplyScalar( .1 ) );
            }
            /*center.position.x = Math.sin( timer.value /2 ) * 120;
            center.position.y = Math.cos( timer.value /1 ) * 120;
            center.position.z = Math.cos( timer.value / 1.5542) * 100;*/

          }

          if( !physicsPaused ){


            for( var i = 0; i < furryTails.length; i++ ){

              var furryTail = furryTails[i];
              furryTail.updateTail();

            }

          }

          if( !movementPaused ){


            for( var i = 0; i < furryTails.length; i++ ){

              var furryTail = furryTails[i];
              furryTail.updatePhysics();

            }


          }

        }

        //physicsRenderer.update();

        requestAnimationFrame( animate );
        controls.update();
        renderer.render( scene , camera );

      }

       function onResize() {
        windowHalfX = window.innerWidth / 2;
        windowHalfY = window.innerHeight / 2;
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }



    </script>

  </body>
</html>
