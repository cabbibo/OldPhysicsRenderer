<html>


  <head>
    <style>
      #container{ position:absolute; left:0px; top:0px; z-index:0; width:100%; height:100%; display:block; overflow:hidden}
      body{ margin:0px; }
    </style>
  </head>

  <body>
    <div id="container"></div>


    <script src="../lib/leap.js"></script>
    
    <script src="../lib/three.js"></script>
    <script src="../lib/jquery.min.js"></script>
    <script src="../lib/TrackballControls.js"></script>
    <script src="../lib/ShaderLoader.js"></script>
    <script src="../lib/dat.gui.min.js"></script>

    <script src="../lib/AudioController.js"></script>
    <script src="../lib/AudioTexture.js"></script>
    <script src="../lib/Stream.js"></script>
    <script src="../lib/UserAudio.js"></script>
    <script src="../lib/underscore.js"></script>


    <script src="../ParticleUtils.js"></script>
    <script src="../PhysicsRenderer.js"></script>

    <script src="js/createLineGeo.js"></script>

    <script src="js/FurryGroup.js"></script>
    <script src="js/FurryTail.js"></script>
    <script src="js/Cloth.js"></script>
    <script src="js/Tendrils.js"></script>
    <script src="js/Monome.js"></script>

    <script src="js/initTextParticles.js"></script>
    <script src="js/initRiggedSkeleton.js"></script>


    <script src="../lib/TextParticles.js"></script>

    <script src="../lib/ObjectControls.js"></script>
    <script src="../lib/RiggedSkeleton.js"></script>
    <script src="../lib/Looper.js"></script>

    <script>

      var colorScheme = [ 
       
        'Loki',
        10,
        new THREE.Color( '#1157ff' ),
        new THREE.Color( '#00a4ff' ),
        new THREE.Color( '#5e2dff' ),
        new THREE.Color( '#00fff0' ),
        
      ];

      var centerPaused, movementPaused , physicsPaused = false;

      var audioController = new AudioController();
      
      
      
      audioController.mute.gain.value = 0.0;

      var userAudio = new UserAudio( audioController );
      
      userAudio.onStreamCreated = function(){
        init();
        animate();
      }

      //var stream = new Stream( '../../audio/saturnStrobe.mp3' , audioController );
      //stream.play();


      
      var t_audio = audioController.texture;
      console.log( t_audio );
      
      var camera, renderer, scene , controls , clock;

      var center;

      var colors = [];
      var gui = new dat.GUI({});

      var particleSystem;
      var physicsRenderer , uniforms;

      var furryTails = [];
      var leader;

      var dT = { type:"f" , value:0 }

      var timer = { type:"f" , value:0 };

      var tendrils;


      var looper = new Looper( audioController , timer , {

        beatsPerMinute: 122,
        beatsPerMeasure: 1,
        measuresPerLoop: 16
    
      });

      looper.onNewMeasure = function(){

       // console.log( this.relativeMeasure );
       // console.log('hello');

       console.log('asags');

       tendrils.updateBases( this.relativeMeasure );
      }

      var shaders = new ShaderLoader('../shaders');

      shaders.shaderSetLoaded = function(){
        //init();
        //animate();
        //stream.play();
      }

      shaders.load( 'vs-tendril' , 'tendril' , 'vertex' );
      shaders.load( 'fs-tendril' , 'tendril' , 'fragment' );
      
      shaders.load( 'vs-tendrilLine' , 'tendrilLine' , 'vertex' );
      shaders.load( 'fs-tendrilLine' , 'tendrilLine' , 'fragment' );

      shaders.load( 'tendrilSim'  , 'tendrilSim' , 'simulation'  );

      shaders.load( 'fs-spring' , 'render'  , 'fragment'    );
      shaders.load( 'vs-render' , 'render'  , 'vertex'      );
      shaders.load( 'tailSim'   , 'tailSim' , 'simulation'  );
      shaders.load( 'jellySim'  , 'jellySim' , 'simulation'  );
      shaders.load( 'fs-lineRender' , 'lineRender' , 'fragment' );
      shaders.load( 'vs-lineRender' , 'lineRender' , 'vertex' );
      shaders.load( 'vs-iri' , 'iri' , 'vertex' );
      shaders.load( 'fs-iri' , 'iri' , 'fragment' );
      shaders.load( 'vs-jelly' , 'jelly' , 'vertex' );
      shaders.load( 'fs-jelly' , 'jelly' , 'fragment' );

      shaders.load( 'fs-planet' , 'planet' , 'fragment' );
      shaders.load( 'vs-planet' , 'planet' , 'vertex' );


      // TEXT
      shaders.load( 'vs-text' , 'text'         , 'vertex'    );
      shaders.load( 'fs-text' , 'text'         , 'fragment'  );
      shaders.load( 'fs-textSim'  , 'textPhysics'  , 'simulation');


      var repelObjects    = [];
      var repelPositions  = [];
      var repelVelocities = [];
      var repelRadii      = [];

      var groups = [];

      function init(){

        /*

          THREE.js Initialization

        */

        var w = window.innerWidth;
        var h = window.innerHeight;

        camera = new THREE.PerspectiveCamera( 65 , w/h , 1 , 200000 );
        camera.position.z = 200;

        //controls = new THREE.TrackballControls( camera );
        scene = new THREE.Scene();

        clock = new THREE.Clock();

        renderer = new THREE.WebGLRenderer({autoclear:false});
        renderer.setSize( window.innerWidth, window.innerHeight );

        var container = document.getElementById('container' );
        controls = new THREE.TrackballControls( camera , container );
        container.appendChild( renderer.domElement );


        center = new THREE.Mesh( 
          new THREE.IcosahedronGeometry( 10 , 0 ),
          new THREE.MeshNormalMaterial()
        );

        controller = new Leap.Controller();
        controller.connect();

        initRiggedSkeleton( center );
        objectControls = new ObjectControls( 
          camera , 
          riggedSkeleton.hand , 
          riggedSkeleton1.hand , 
          controller , 
          {
            indicator : center     
          }
        );



        for( var i = 0; i< 10; i++ ){

          var repelObject = {}

          repelObject.mesh = center.clone();
          repelObject.velocity = new THREE.Vector3();
          repelObject.position = new THREE.Vector3(
            (Math.random() -.5 ) * 5000,
            (Math.random() -.5 ) * 5000,
            Math.random() * 1000
          );
          repelObject.mesh.position = repelObject.position;
  
          repelObject.radius = 600;

          repelPositions.push(  repelObject.position );
          repelVelocities.push( repelObject.velocity );
          repelRadii.push(      repelObject.radius );

          repelObjects.push( repelObject );

          scene.add( repelObject.mesh );

        }

       /* var c = colorScheme;

        var numOf = c[1]; //+ Math.floor( Math.random() * 10 );

        var col1 = new THREE.Vector3( c[2].r , c[2].g , c[2].b );
        var col2 = new THREE.Vector3( c[3].r , c[3].g , c[3].b );
        var col3 = new THREE.Vector3( c[4].r , c[4].g , c[4].b );
        var col4 = new THREE.Vector3( c[5].r , c[5].g , c[5].b );

        furryGroup = new FurryGroup( c[0] , 1 , {
            
          center: center,
          bait:   center.clone(),
          color1: col1,
          color2: col2,
          color3: col3,
          color4: col4,

        });

        furryGroup.updateBrethren();        

        console.log('ashasss');
        console.log( furryTails );

        furryTails[0].addDistanceSquaredForce( riggedSkeleton.hand.position , 100 );
*/
        tendrils = new Tendrils({
          position:new THREE.Vector3(),
          repelPositions: repelPositions,
          repelVelocities: repelVelocities,
          repelRadii: repelRadii,
          width: 5000,
          height: 5000,
          girth: 50,
        });

        tendrils.activate();

        looper.start();
    
        window.addEventListener( 'resize', onResize , false );
        
        document.addEventListener( 'keydown' , function(e){

          console.log( e.which );
          if( e.which == 32 ){

            centerPaused = !centerPaused;

          }

          if( e.which == 45 ){

            physicsPaused = !physicsPaused;

          }

          if( e.which == 90 ){

            movementPaused = !movementPaused;

          }



        });
      }



      function animate(){

        //console.log( 

        dT.value = clock.getDelta();

        timer.value += dT.value;

        audioController.update();

        if( !centerPaused ){
          tendrils.update();
        }


        riggedSkeleton.update();
        riggedSkeleton1.update();

        for( var i = 0; i < furryTails.length; i++ ){

        //  console.log('asas');
         // var furryTail = furryTails[i];
        //  furryTail.updateTail();

        //  furryTail.updatePhysics();
        }




        for( var i = 0; i < repelObjects.length; i++ ){

          var rO = repelObjects[i];

          var force = new THREE.Vector3();


          for( var j = 0; j < repelObjects.length; j++ ){
            if( j != i ){




            }
          }





          rO.velocity.add( force );

          rO.position.add( rO.velocity );
          rO.velocity.multiplyScalar( .9 );


        }


       /* if( !centerPaused ){

          center.position.x = Math.sin( timer.value * 1.73 ) * 12;
          center.position.y = Math.cos( timer.value * 1.3 ) * 12;
          center.position.z = Math.cos( timer.value * 2) * 10;

        }*/

        //physicsRenderer.update();

        requestAnimationFrame( animate );
        controls.update();
        renderer.render( scene , camera );

      }

      function onResize() {
        windowHalfX = window.innerWidth / 2;
        windowHalfY = window.innerHeight / 2;
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }



    </script>

  </body>
</html>
